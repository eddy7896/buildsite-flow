# ============================================================================
# BuildFlow - Development Docker Compose Configuration
# ============================================================================
# Hot-reloading enabled for both frontend and backend
# Changes are reflected automatically without rebuilding
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # PostgreSQL Database (same as production)
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: buildflow-postgres-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin}
      POSTGRES_DB: buildflow_db
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
      - ./src/database/migrations:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - buildflow-network-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --------------------------------------------------------------------------
  # Redis Cache (same as production)
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: buildflow-redis-dev
    command: redis-server --appendonly yes
    volumes:
      - redis_data_dev:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - buildflow-network-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------------------------
  # Backend API Server - Development Mode with Hot Reload
  # --------------------------------------------------------------------------
  backend:
    image: node:20-alpine
    container_name: buildflow-backend-dev
    working_dir: /app
    environment:
      # Server Configuration
      NODE_ENV: development
      PORT: ${BACKEND_PORT:-3000}
      
      # Database Configuration
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-admin}@postgres:${POSTGRES_PORT:-5432}/buildflow_db
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      DATABASE_PORT: ${POSTGRES_PORT:-5432}
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      
      # Application Configuration
      APP_NAME: ${APP_NAME:-Haal - Agency Management Platform}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      APP_ENVIRONMENT: development
      
      # API & Frontend URLs
      API_URL: ${API_URL:-http://localhost:3000/api}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://localhost:5174,http://localhost:3000,http://localhost:8080}
      
      # Authentication
      JWT_SECRET: ${JWT_SECRET:-${VITE_JWT_SECRET:-7VEfW3OgaWRzOU85cGpVf60YCkusjOXZASouFPzI/gs=}}
      
      # File Storage
      FILE_STORAGE_PATH: /app/storage
      
      # Email Configuration (Optional)
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
      
      # File Watching Configuration (Windows/WSL compatibility)
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: 1000
      WATCHPACK_POLLING: "true"
      # Nodemon polling (handled via nodemon.json, but env var as fallback)
      NODEMON_POLLING: "true"
    volumes:
      # Mount source code for hot-reloading
      - ./src/server:/app
      - backend_storage_dev:/app/storage
      - backend_node_modules_dev:/app/node_modules  # Named volume for better control
    ports:
      - "${BACKEND_PORT:-3000}:${BACKEND_PORT:-3000}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - buildflow-network-dev
    restart: unless-stopped
    # Improved command: checks package.json timestamp to detect dependency changes
    command: >
      sh -c "
        cd /app &&
        if [ ! -d node_modules ] || [ ! -f node_modules/.package-lock-check ] || [ package.json -nt node_modules/.package-lock-check ]; then
          echo '[Backend] Installing/updating dependencies...' &&
          npm install &&
          mkdir -p node_modules &&
          touch node_modules/.package-lock-check
        fi &&
        echo '[Backend] Starting dev server with hot reload...' &&
        npm run dev
      "
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  # --------------------------------------------------------------------------
  # Frontend (React + Vite) - Development Mode with Hot Reload
  # --------------------------------------------------------------------------
  frontend:
    image: node:20-alpine
    container_name: buildflow-frontend-dev
    working_dir: /app
    environment:
      # Vite Configuration
      VITE_API_URL: ${VITE_API_URL:-http://localhost:3000/api}
      VITE_APP_NAME: ${VITE_APP_NAME:-${APP_NAME:-Haal - Agency Management Platform}}
      VITE_APP_VERSION: ${VITE_APP_VERSION:-${APP_VERSION:-1.0.0}}
      VITE_APP_ENVIRONMENT: development
      NODE_ENV: development
      # Vite dev server configuration
      VITE_DEV_SERVER_HOST: 0.0.0.0
      VITE_DEV_SERVER_PORT: 5173
      # File Watching Configuration (Windows/WSL compatibility)
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: 1000
      WATCHPACK_POLLING: "true"
      # Vite HMR configuration for Docker
      # HMR host should be accessible from browser (use localhost when accessing via host machine)
      VITE_HMR_PORT: 5173
      VITE_HMR_HOST: localhost
      VITE_HMR_CLIENT_PORT: 5173
    volumes:
      # Mount root directory: Vite needs root-level config files (vite.config.ts, package.json, 
      # index.html, tailwind.config.ts, etc.) and frontend source is in src/
      # Backend is isolated at ./src/server, so no cross-contamination
      - .:/app
      - frontend_node_modules_dev:/app/node_modules  # Named volume for better control
      - frontend_dist_dev:/app/dist  # Named volume for build output
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    depends_on:
      backend:
        condition: service_started
    networks:
      - buildflow-network-dev
    restart: unless-stopped
    # Improved command: checks package.json timestamp to detect dependency changes
    command: >
      sh -c "
        if [ ! -d node_modules ] || [ ! -f node_modules/.package-lock-check ] || [ package.json -nt node_modules/.package-lock-check ]; then
          echo '[Frontend] Installing/updating dependencies...' &&
          npm install &&
          mkdir -p node_modules &&
          touch node_modules/.package-lock-check
        fi &&
        echo '[Frontend] Starting Vite dev server with hot reload...' &&
        npm run dev -- --host 0.0.0.0
      "
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:5173', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

# ============================================================================
# Networks
# ============================================================================
networks:
  buildflow-network-dev:
    driver: bridge
    name: buildflow-network-dev

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data_dev:
    driver: local
    name: buildflow-postgres-data-dev
  redis_data_dev:
    driver: local
    name: buildflow-redis-data-dev
  backend_storage_dev:
    driver: local
    name: buildflow-backend-storage-dev
  backend_node_modules_dev:
    driver: local
    name: buildflow-backend-node-modules-dev
  frontend_node_modules_dev:
    driver: local
    name: buildflow-frontend-node-modules-dev
  frontend_dist_dev:
    driver: local
    name: buildflow-frontend-dist-dev

