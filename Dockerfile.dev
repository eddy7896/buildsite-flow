# Optimized Development Dockerfile for Frontend (with hot reload)
# Improvements: npm ci for reproducibility, build cache mounts, retry logic, better error handling

# Use build argument for Node version with fallback
ARG NODE_VERSION=20-alpine
FROM node:${NODE_VERSION}

# Set build arguments for better control
ARG NPM_REGISTRY=https://registry.npmjs.org/
ARG BUILDKIT_INLINE_CACHE=1

# Configure npm with retry settings and registry
RUN npm config set registry ${NPM_REGISTRY} && \
    npm config set fetch-retries 5 && \
    npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm config set fetch-timeout 300000

WORKDIR /app

# Copy package files first for better layer caching
COPY package.json package-lock.json* ./

# Install dependencies with cache mount and retry logic
# Using sh -c to allow retry logic
RUN --mount=type=cache,target=/root/.npm \
    --mount=type=cache,target=/app/.npm \
    sh -c ' \
    for i in 1 2 3 4 5; do \
        npm ci --prefer-offline --no-audit && break || \
        (echo "Attempt $i failed, retrying in 5 seconds..." && sleep 5); \
    done || exit 1'

# Copy config files
COPY tsconfig*.json vite.config.ts tailwind.config.ts postcss.config.js components.json ./

# Copy source files (will be overridden by volume mounts in dev, but ensures container works standalone)
COPY src ./src
COPY public ./public
COPY index.html ./

# Create non-root user for security and install su-exec for user switching
RUN apk add --no-cache su-exec && \
    addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001 && \
    chown -R nodejs:nodejs /app && \
    mkdir -p /app/node_modules/.vite-temp && \
    chown -R nodejs:nodejs /app/node_modules/.vite-temp && \
    chmod -R 777 /app/node_modules/.vite-temp

USER nodejs

# Expose Vite dev server port
EXPOSE 5173

# Health check for container
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:5173', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" || exit 1

# Start Vite dev server with host binding
CMD ["npm", "run", "dev", "--", "--host"]
